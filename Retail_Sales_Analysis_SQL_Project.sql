SELECT TOP 2 * FROM CUSTOMER
SELECT TOP 2 * FROM TRANSACTIONS
SELECT TOP 2 * FROM PROD_CAT_INFO

--Q1. TOTAL NO OF ROWS IN EACH TABLE.
SELECT COUNT(*) AS TOTAL_ROWS FROM CUSTOMER
SELECT COUNT(*) AS TOTAL_ROWS FROM TRANSACTIONS
SELECT COUNT(*) AS TOTAL_ROWS FROM PROD_CAT_INFO

--Q2 NO. OF TRANS. THAT HAVE RETURN
SELECT COUNT(A.TRANSACTION_ID) RETURNS_ FROM TRANSACTIONS AS A
WHERE A.QTY <0

--Q3. AS YOU WOULD HAVE NOTICED, THE DATES PROVIDED ACROSS THE DATASETS ARE NOT IN A CORRECT FORMAT
-- AS FIRST STEPS, PLS CONVERT THE DATE VARIABLES INTO VALID DATE FORMATS BEFORE PROCEEDING AHEAD.
SELECT * FROM TRANSACTIONS
SELECT FORMAT(TRAN_DATE, 'DD-MM-YYYY') AS FORMATTED_DATE
FROM TRANSACTIONS;

--4.WHAT IS THE TIME RANGE OF THE TRANSACTION DATA AVAILABLE FOR ANALYSIS? SHOW THE OUTPUT IN 
--NUMBER OF DAYS, MONTHS AND YEARS SIMULTANEOUSLY IN DIFFERENT COLUMNS.
SELECT
MAX(A.TRAN_DATE) AS LATEST_DATE,
MIN(A.TRAN_DATE) AS OLDEST_DATE,
DATEDIFF(DAY,MIN(A.TRAN_DATE),MAX(A.TRAN_DATE)) AS DAY_GAP,
DATEDIFF(MONTH,MIN(A.TRAN_DATE),MAX(A.TRAN_DATE)) AS MONTH_GAP,
DATEDIFF(YEAR,MIN(A.TRAN_DATE),MAX(A.TRAN_DATE)) AS YEAR_GAP
FROM TRANSACTIONS AS A 

--5.	WHICH PRODUCT CATEGORY DOES THE SUB-CATEGORY “DIY” BELONG TO?
SELECT A.PROD_CAT,A.PROD_SUBCAT
FROM PROD_CAT_INFO AS A
WHERE A.PROD_SUBCAT = 'DIY'

			   --DATA ANALYSIS

--1.	WHICH CHANNEL IS MOST FREQUENTLY USED FOR TRANSACTIONS?
SELECT TOP 1 A.STORE_TYPE,COUNT(A.STORE_TYPE) AS TOTAL_TRANSACTIONS
FROM TRANSACTIONS AS A
GROUP BY A.STORE_TYPE
ORDER BY TOTAL_TRANSACTIONS DESC

--2.	WHAT IS THE COUNT OF MALE AND FEMALE CUSTOMERS IN THE DATABASE?
SELECT DISTINCT A.GENDER, COUNT(A.GENDER) AS GENDER_COUNT
FROM CUSTOMER AS A
GROUP BY A.GENDER

--3.	FROM WHICH CITY DO WE HAVE THE MAXIMUM NUMBER OF CUSTOMERS AND HOW MANY?
SELECT TOP 1 A.CITY_CODE, COUNT(A.CUSTOMER_ID) AS CUSTOMER_COUNT
FROM CUSTOMER AS A
GROUP BY A.CITY_CODE 
ORDER BY CUSTOMER_COUNT DESC

--4.	HOW MANY SUB-CATEGORIES ARE THERE UNDER THE BOOKS CATEGORY?
SELECT A.PROD_CAT, COUNT(DISTINCT A.PROD_SUBCAT) AS COUNT_SUBCAT
FROM PROD_CAT_INFO AS A
WHERE A.PROD_CAT = 'BOOKS'
GROUP BY A.PROD_CAT

--5.	WHAT IS THE MAXIMUM QUANTITY OF PRODUCTS EVER ORDERED?
SELECT TOP 1 A.QTY ,COUNT(A.QTY) AS MAX_QUANTITY FROM TRANSACTIONS AS A
GROUP BY A.QTY
ORDER BY MAX_QUANTITY DESC

--6. WHAT IS THE NET TOTAL REVENUE GENERATED IN CATEGORIES ELECTRONICS AND BOOKS?
SELECT A.PROD_CAT_CODE, SUM(A.TOTAL_AMT) AS TOTAL_REVENUE
FROM TRANSACTIONS AS A
WHERE A.PROD_CAT_CODE IN ( SELECT B.PROD_CAT_CODE FROM PROD_CAT_INFO AS B
                           WHERE B.PROD_CAT IN ('ELECTRONICS', 'BOOKS'))
GROUP BY A.PROD_CAT_CODE

--7. HOW MANY CUSTOMERS HAVE >10 TRANSACTIONS WITH US, EXCLUDING RETURNS?
SELECT COUNT(*) AS CUSTOMER_COUNT FROM (
                     SELECT A.CUST_ID, COUNT(A.CUST_ID) AS CUST_COUNT
                     FROM TRANSACTIONS AS A
                     WHERE A.QTY>=0
                     GROUP BY A.CUST_ID
                     HAVING COUNT(A.TRANSACTION_ID)>10
					 ) AS T

--8. WHAT IS THE COMBINED REVENUE EARNED FROM THE “ELECTRONICS” & “CLOTHING” CATEGORIES, 
--   FROM “FLAGSHIP STORES”?
SELECT  ROUND(SUM(A.TOTAL_AMT),1) AS TOTAL_REVENUE 
FROM TRANSACTIONS AS A
WHERE A.STORE_TYPE = 'FLAGSHIP STORE'
AND A.PROD_CAT_CODE IN(  

                       SELECT DISTINCT B.PROD_CAT_CODE
                       FROM PROD_CAT_INFO AS B
                       WHERE B.PROD_CAT IN ('CLOTHING', 'ELECTRONICS') )

--9. WHAT IS THE TOTAL REVENUE GENERATED FROM “MALE” CUSTOMERS IN “ELECTRONICS” CATEGORY?
--   OUTPUT SHOULD DISPLAY TOTAL REVENUE BY PROD SUB-CAT.
SELECT  ROUND(SUM(A.TOTAL_AMT),1) AS TOTAL_REVENUE FROM TRANSACTIONS AS A
WHERE A.CUST_ID IN (
                  SELECT C.CUSTOMER_ID FROM CUSTOMER AS C
				  WHERE C.GENDER = 'M')
AND A.PROD_CAT_CODE IN(
				  SELECT B.PROD_CAT_CODE FROM PROD_CAT_INFO AS B
				  WHERE B.PROD_CAT = 'ELECTRONICS') 


SELECT B.PROD_SUBCAT ,ROUND(SUM(A.TOTAL_AMT),1) AS TOTAL_REVENUE FROM TRANSACTIONS AS A
LEFT JOIN PROD_CAT_INFO AS B
ON A.PROD_CAT_CODE = B.PROD_CAT_CODE AND A.PROD_SUBCAT_CODE = B.PROD_SUB_CAT_CODE
LEFT JOIN CUSTOMER AS C
ON A.CUST_ID = C.CUSTOMER_ID
WHERE B.PROD_CAT = 'ELECTRONICS' 
AND 
C.GENDER = 'M'
GROUP BY B.PROD_SUBCAT

--10. WHAT IS PERCENTAGE OF SALES AND RETURNS BY PRODUCT SUB CATEGORY; 
--    DISPLAY ONLY TOP 5 SUB CATEGORIES IN TERMS OF SALES?

SELECT TOP 5 
PROD_SUBCAT, (SUM(T.TOTAL_AMT)/(SELECT SUM(T.TOTAL_AMT) FROM TRANSACTIONS AS T))*100 AS PERCANTAGE_OF_SALES, 
(COUNT(CASE WHEN QTY< 0 THEN QTY ELSE NULL END)/SUM(QTY))*100 AS PERCENTAGE_OF_RETURN
FROM TRANSACTIONS AS T
INNER JOIN PROD_CAT_INFO AS P ON P.PROD_CAT_CODE = P.PROD_CAT_CODE AND	P.PROD_SUB_CAT_CODE=P.PROD_SUB_CAT_CODE
GROUP BY P.PROD_SUBCAT
ORDER BY SUM(TOTAL_AMT) DESC

--11 FOR ALL CUSTOMERS AGED BETWEEN 25 TO 35 YEARS FIND WHAT IS THE NET TOTAL REVENUE GENERATED BY 
--THESE CONSUMERS IN LAST 30 DAYS OF TRANSACTIONS FROM MAX TRANSACTION DATE AVAILABLE IN THE DATA?

SELECT A.CUST_ID ,SUM(A.TOTAL_AMT) AS TOTAL_REVENUE FROM TRANSACTIONS AS A
WHERE A.CUST_ID IN (
                    SELECT B.CUSTOMER_ID FROM CUSTOMER AS B
                    WHERE DATEDIFF(YEAR,B.DOB,GETDATE()) BETWEEN 25 AND 35)
AND A.TRAN_DATE IN(
                SELECT C.TRAN_DATE FROM TRANSACTIONS AS C
                WHERE C.TRAN_DATE BETWEEN DATEADD(DAY,-30,(SELECT MAX(TRAN_DATE)FROM TRANSACTIONS)) 
                AND (SELECT MAX(TRAN_DATE) FROM TRANSACTIONS)
                    )
GROUP BY A.CUST_ID


--12. WHICH PRODUCT CATEGORY HAS SEEN THE MAX VALUE OF RETURNS IN THE LAST 3 MONTHS OF TRANSACTIONS?
SELECT TOP 1 A.PROD_CAT_CODE, B.PROD_CAT,SUM(A.QTY) AS VALUE_OF_RETURN 
FROM TRANSACTIONS AS A
INNER JOIN PROD_CAT_INFO AS B
ON A.PROD_CAT_CODE = B.PROD_CAT_CODE AND A.PROD_SUBCAT_CODE = B.PROD_SUB_CAT_CODE
WHERE A.QTY <0 AND 
A.TRAN_DATE IN (
               SELECT C.TRAN_DATE FROM TRANSACTIONS AS C
               WHERE C.TRAN_DATE BETWEEN DATEADD(MONTH,-3, (SELECT MAX(TRAN_DATE) FROM TRANSACTIONS))
               AND (SELECT MAX(TRAN_DATE) FROM TRANSACTIONS )
               )
GROUP BY A.PROD_CAT_CODE, B.PROD_CAT
ORDER BY VALUE_OF_RETURN 

--13. WHICH STORE-TYPE SELLS THE MAXIMUM PRODUCTS; BY VALUE OF SALES AMOUNT AND BY QUANTITY SOLD?
SELECT TOP 1 A.STORE_TYPE , SUM(A.TOTAL_AMT) AS SALES_AMOUNT, SUM(A.QTY) AS SOLD_QUANTITY
FROM TRANSACTIONS AS A
GROUP BY A.STORE_TYPE
ORDER BY SALES_AMOUNT DESC , SOLD_QUANTITY DESC

--14.	WHAT ARE THE CATEGORIES FOR WHICH AVERAGE REVENUE IS ABOVE THE OVERALL AVERAGE.
SELECT B.PROD_CAT, AVG(A.TOTAL_AMT) AS AVG_REVENUE FROM TRANSACTIONS AS A 
LEFT JOIN PROD_CAT_INFO AS B
ON A.PROD_CAT_CODE = B.PROD_CAT_CODE AND A.PROD_SUBCAT_CODE = B.PROD_SUB_CAT_CODE
GROUP BY B.PROD_CAT
HAVING AVG(A.TOTAL_AMT)> (SELECT AVG(TOTAL_AMT) FROM TRANSACTIONS)
ORDER BY AVG_REVENUE DESC

--15. FIND THE AVERAGE AND TOTAL REVENUE BY EACH SUBCATEGORY FOR THE CATEGORIES
--    WHICH ARE AMONG TOP 5 CATEGORIES IN TERMS OF QUANTITY SOLD.
SELECT B.PROD_CAT ,B.PROD_SUBCAT, 
AVG(A.TOTAL_AMT) AS AVG_REVENUE,SUM(A.TOTAL_AMT) AS TOTAL_REVENUE
FROM TRANSACTIONS AS A
LEFT JOIN PROD_CAT_INFO AS B
ON A.PROD_CAT_CODE = B.PROD_CAT_CODE AND A.PROD_SUBCAT_CODE = B.PROD_SUB_CAT_CODE
WHERE B.PROD_CAT IN (
                    SELECT TOP 5 B.PROD_CAT FROM TRANSACTIONS AS A
                    LEFT JOIN PROD_CAT_INFO AS B
                    ON A.PROD_CAT_CODE = B.PROD_CAT_CODE AND A.PROD_SUBCAT_CODE = B.PROD_SUB_CAT_CODE
                    GROUP BY B.PROD_CAT
                    ORDER BY SUM(A.QTY) DESC
					)

GROUP BY B.PROD_CAT,B.PROD_SUBCAT



------------------------           XXXXXXX   ----    XXXXXXX         ----------------------------